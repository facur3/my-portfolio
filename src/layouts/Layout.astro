---
import { ViewTransitions } from "astro:transitions";
import SpeedInsights from "@vercel/speed-insights/astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Navbar from "../components/Navbar.astro";
import "../styles/design-system.css";
// Supports weights 100-900
import "@fontsource/inter/100.css";
import "@fontsource/inter/400.css";
import "@fontsource/inter/500.css";
import "@fontsource/inter/700.css";
import "@fontsource/inter/900.css";
// Supports weights 300-700
import "@fontsource/space-grotesk/300.css";
import "@fontsource/space-grotesk/400.css";
import "@fontsource/space-grotesk/500.css";
import "@fontsource/space-grotesk/600.css";
import "@fontsource/space-grotesk/700.css";

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
        />
        <title>{title}</title>

        <!-- SEO Meta Tags -->
        <meta
            name="description"
            content="Facundo Rossi's Portfolio â€“ Software Engineer specializing in modern solutions, AI, Web Development, and Full-stack Systems."
        />
        <meta
            name="keywords"
            content="Facu Rossi, Portfolio, Developer, Programmer, AI, Web, Full-stack"
        />

        <!-- Speed Insights -->
        <SpeedInsights />

        <!-- Open Graph / Facebook -->
        <meta property="og:title" content="Facundo Rossi - Portfolio" />
        <meta
            property="og:description"
            content="Software Engineer specializing in building scalable systems and high-performance web experiences."
        />
        <meta property="og:image" content="/social-share.png" />
        <meta
            property="og:url"
            content="https://my-portfolio-seven-gules-67.vercel.app/"
        />
        <meta property="og:type" content="website" />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="Facundo Rossi - Portfolio" />
        <meta
            name="twitter:description"
            content="Software Engineer specializing in building scalable systems and high-performance web experiences."
        />
        <meta name="twitter:image" content="/social-share.png" />

        <!-- Favicon and Web Manifest -->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />

        <!-- View Transitions -->
        <ViewTransitions />

        <!-- Dark Theme Initialization Script -->
        <script is:inline>
            (function () {
                const savedTheme = localStorage.getItem("theme") || "dark"; // Default to dark
                const systemDark = window.matchMedia(
                    "(prefers-color-scheme: dark)",
                ).matches;
                if (
                    savedTheme === "dark" ||
                    (savedTheme === "system" && systemDark)
                ) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            })();
        </script>

        <script is:inline type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Person",
                "name": "Facundo Rossi",
                "jobTitle": "Software Engineer",
                "url": "https://my-portfolio-seven-gules-67.vercel.app/",
                "sameAs": [
                    "https://www.linkedin.com/in/facundo-rossi-a5839a278/",
                    "https://github.com/facur3"
                ],
                "alumniOf": {
                    "@type": "EducationalOrganization",
                    "name": "Universidad de Buenos Aires"
                },
                "hasOccupation": {
                    "@type": "Occupation",
                    "name": "Software Developer",
                    "skills": [
                        "JavaScript",
                        "Python",
                        "React",
                        "AI",
                        "Astro",
                        "Tailwind CSS"
                    ]
                }
            }
        </script>
    </head>
    <body
        id="top"
        class="bg-white dark:bg-[#0f0f0f] text-zinc-900 dark:text-white antialiased selection:bg-primary-500/30 w-full overflow-x-hidden pt-[env(safe-area-inset-top)] transition-colors duration-300 font-sans"
    >
        <!-- Noise Texture Overlay -->
        <div class="noise-overlay"></div>

        <!-- Clean Minimalist Background with subtle gradient -->
        <div
            class="fixed inset-0 -z-50 bg-gradient-to-br from-zinc-50 to-zinc-200 dark:from-[#0f0f0f] dark:to-[#1a1a1a] transition-colors duration-300"
        >
            <div
                class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary-900/10 rounded-full blur-[120px] pointer-events-none"
            >
            </div>
            <div
                class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-secondary-900/5 rounded-full blur-[100px] pointer-events-none"
            >
            </div>
        </div>

        <Navbar />

        <main
            class="w-full max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 relative z-10"
        >
            <slot />
        </main>

        <Footer />

        <!-- Scroll to Top Button (Mobile Only) -->
        <button
            id="scroll-to-top"
            aria-label="Back to top"
            class="fixed bottom-6 right-6 z-50 p-3 rounded-full bg-white dark:bg-zinc-900/90 text-zinc-900 dark:text-white shadow-lg backdrop-blur-sm border border-zinc-300 dark:border-zinc-700/50 opacity-0 translate-y-10 pointer-events-none transition-all duration-300 md:hidden"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="size-6"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 5l0 14"></path>
                <path d="M18 11l-6 -6"></path>
                <path d="M6 11l6 -6"></path>
            </svg>
        </button>
    </body>
</html>

<style is:global>
    html {
        font-family: "Inter", system-ui, sans-serif;
        scroll-behavior: auto; /* Handled by Lenis */
        scroll-padding-top: 100px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Space Grotesk", sans-serif;
    }

    html.dark {
        color-scheme: dark;
    }

    /* Lenis Styles */
    html.lenis,
    html.lenis body {
        height: auto;
    }

    .lenis.lenis-smooth {
        scroll-behavior: auto !important;
    }

    .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
    }

    .lenis.lenis-stopped {
        overflow: hidden;
    }

    .lenis.lenis-scrolling iframe {
        pointer-events: none;
    }
</style>

<script>
    import Lenis from "@studio-freight/lenis";

    // Initialize Lenis
    const lenis = new Lenis({
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        orientation: "vertical",
        gestureOrientation: "vertical",
        smoothWheel: true,
    });

    function raf(time: number) {
        lenis.raf(time);
        requestAnimationFrame(raf);
    }

    requestAnimationFrame(raf);

    // Intersection Observer for Scroll Reveals
    const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add("active");
                observer.unobserve(entry.target); // Only animate once
            }
        });
    }, observerOptions);

    document.addEventListener("astro:page-load", () => {
        // Re-init or handle page transitions if needed
        document
            .querySelectorAll(".reveal")
            .forEach((el) => observer.observe(el));
    });

    // Fallback for initial load
    document.addEventListener("DOMContentLoaded", () => {
        document
            .querySelectorAll(".reveal")
            .forEach((el) => observer.observe(el));
    });

    // Scroll to Top Logic
    const scrollBtn = document.getElementById("scroll-to-top");

    if (scrollBtn) {
        window.addEventListener("scroll", () => {
            if (window.scrollY > 1300) {
                scrollBtn.classList.remove(
                    "opacity-0",
                    "translate-y-10",
                    "pointer-events-none",
                );
                scrollBtn.classList.add(
                    "opacity-0",
                    "translate-y-10",
                    "pointer-events-none",
                );
            }
        });

        scrollBtn.addEventListener("click", () => {
            lenis.scrollTo(0);
        });
    }

    // Intercept Anchor Links for Smooth Scroll via Lenis
    document
        .querySelectorAll('a[href^="/#"], a[href^="#"]')
        .forEach((anchor) => {
            anchor.addEventListener("click", function (e) {
                const currentTarget = e.currentTarget as HTMLAnchorElement;
                const href = currentTarget.getAttribute("href");
                // Extract the hash part
                const targetId =
                    href && href.includes("#") ? href.split("#")[1] : null;

                if (targetId) {
                    const targetElement = document.getElementById(targetId);
                    // Only intercept if we are on the same page and target exists
                    if (
                        targetElement &&
                        (window.location.pathname === "/" ||
                            (href && href.startsWith("#")))
                    ) {
                        e.preventDefault();
                        // Offset -100px to account for the fixed header
                        lenis.scrollTo(targetElement, { offset: -100 });

                        // Optional: Update URL without jump
                        history.pushState(null, "", `#${targetId}`);
                    }
                }
            });
        });
</script>
